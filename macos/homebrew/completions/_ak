#compdef ak ak-gui

# AK Zsh Completion
# This file provides zsh completion for the ak command-line tool

_ak() {
    local context state state_descr line
    typeset -A opt_args
    
    _arguments -C \
        '(-h --help)'{-h,--help}'[Show help information]' \
        '(-v --version)'{-v,--version}'[Show version information]' \
        '--json[Output in JSON format]' \
        '1: :_ak_commands' \
        '*:: :->args' && return 0
    
    case $state in
        args)
            case $words[1] in
                secret)
                    _ak_secret
                    ;;
                profile)
                    _ak_profile
                    ;;
                service)
                    _ak_service
                    ;;
                guard)
                    _ak_guard
                    ;;
                get|cp|rm)
                    _ak_keys
                    ;;
                load)
                    _ak_profiles_and_keys
                    ;;
                save|unload|duplicate|profiles)
                    _ak_profiles
                    ;;
                set|add)
                    _ak_keys
                    ;;
                env)
                    _ak_env
                    ;;
                purge)
                    _ak_purge
                    ;;
                test)
                    _ak_test_completions
                    ;;
            esac
            ;;
    esac
}

_ak_commands() {
    local commands
    commands=(
        # Main namespaced commands
        'secret:Secret/API key management'
        'profile:Profile management'
        'service:Service configuration and testing'
        'guard:Shell guard controls'
        
        # Legacy/alias commands
        'add:Add a new secret (alias for secret add)'
        'set:Set a secret value (alias for secret set)'
        'get:Get a secret value (alias for secret get)'
        'ls:List secrets (alias for secret ls)'
        'rm:Remove a secret (alias for secret rm)'
        'search:Search secrets (alias for secret search)'
        'cp:Copy secret to clipboard (alias for secret cp)'
        
        # Profile management (legacy aliases)
        'save:Save current profile'
        'load:Load profile or individual key'
        'unload:Unload profile'
        'profiles:List available profiles'
        'duplicate:Duplicate a profile'
        'env:Print export commands for a profile'
        
        # Utilities
        'test:Test API connections'
        'doctor:Diagnose configuration issues'
        'audit:View audit log'
        'export:Export data'
        'import:Import data'
        'migrate:Migrate data'
        'run:Run custom tasks'
        
        # System
        'install-shell:Install shell integration'
        'uninstall:Uninstall ak'
        'completion:Generate completion scripts'
        'serve:Start HTTP server'
        'gui:Launch GUI interface'
        'backend:Show active storage backend'
        'purge:Permanently delete stored data'
        
        # Info
        'help:Show help information'
        'version:Show version information'
        'welcome:Show welcome message'
    )
    _describe 'commands' commands
}

_ak_secret() {
    local secret_commands
    secret_commands=(
        'add:Add a new secret'
        'set:Set a secret value'
        'get:Get a secret value'
        'ls:List all secrets'
        'rm:Remove a secret'
        'search:Search secrets by name pattern'
        'cp:Copy secret to clipboard'
    )
    
    if (( CURRENT == 2 )); then
        _describe 'secret commands' secret_commands
    else
        case $words[2] in
            get|rm|cp|set)
                _ak_keys
                ;;
            add)
                # For add, can suggest existing keys or allow new ones
                _ak_keys
                ;;
            search)
                # For search, just allow any pattern
                ;;
        esac
    fi
}

_ak_profile() {
    local profile_commands
    profile_commands=(
        'save:Save secrets to a profile'
        'load:Load a profile into the shell'
        'unload:Unload profile variables'
        'ls:List profiles'
        'list:Alias for ls'
        'duplicate:Duplicate a profile'
        'rm:Remove a profile'
        'remove:Alias for rm'
    )

    if (( CURRENT == 2 )); then
        _describe 'profile commands' profile_commands
        return
    fi

    case $words[2] in
        save)
            if (( CURRENT == 3 )); then
                _ak_profiles
            else
                _ak_keys
            fi
            ;;
        load|unload)
            (( CURRENT == 3 )) && _ak_profiles
            ;;
        duplicate)
            (( CURRENT == 3 )) && _ak_profiles
            ;;
        rm|remove)
            (( CURRENT == 3 )) && _ak_profiles
            ;;
        ls|list)
            ;;
    esac
}

_ak_service() {
    local service_commands
    service_commands=(
        'ls:List available services'
        'list:Alias for ls'
        'add:Add a new custom service'
        'show:Show service details'
        'edit:Edit a custom service'
        'rm:Remove a custom service'
        'remove:Alias for rm'
        'delete:Alias for rm'
    )

    if (( CURRENT == 2 )); then
        _describe 'service commands' service_commands
        return
    fi

    case $words[2] in
        show|edit|rm|remove|delete)
            _ak_services
            ;;
    esac
}

_ak_guard() {
    local guard_commands
    guard_commands=(
        'enable:Enable shell guard'
        'disable:Disable shell guard'
        'status:Show guard status'
    )

    if (( CURRENT == 2 )); then
        _describe 'guard commands' guard_commands
        return
    fi
}

_ak_env() {
    local env_options
    env_options=(
        '--profile:Profile to export'
    )

    if [[ $words[CURRENT-1] == "--profile" ]]; then
        _ak_profiles
        return
    fi

    _describe 'env options' env_options
}

_ak_purge() {
    local purge_options
    purge_options=(
        '--no-backup:Skip creating a backup before deleting'
        '--force:Bypass interactive confirmation'
    )

    _describe 'purge options' purge_options
}

_ak_test_completions() {
    local test_args
    test_args=(
        '--fail-fast:Stop on first failure'
        '--json:Output in JSON format'  
        '--quiet:Suppress output'
        '-p:Specify profile'
        '--profile:Specify profile'
        '--debug:Show full curl command and response details'
    )
    
    if [[ $words[CURRENT-1] == "-p" || $words[CURRENT-1] == "--profile" ]]; then
        _ak_profiles
    else
        local services profiles keys
        services=(
            'openai:OpenAI API'
            'anthropic:Anthropic Claude API'
            'google:Google APIs'
            'github:GitHub API'
            'gitlab:GitLab API'
            'bitbucket:Bitbucket API'
            'azure:Microsoft Azure APIs'
            'aws:Amazon Web Services APIs'
            'gcp:Google Cloud Platform APIs'
            'digitalocean:DigitalOcean API'
            'linode:Linode API'
            'vultr:Vultr API'
            'hetzner:Hetzner Cloud API'
        )
        
        _alternative \
            'services:services:_describe "services" services' \
            'profiles:profiles:_ak_profiles' \
            'keys:keys:_ak_keys' \
            'options:options:_describe "options" test_args'
    fi
}

# Helper functions to get dynamic completions
_ak_profiles() {
    local profiles
    if (( $+commands[ak] )); then
        profiles=(${(f)"$(ak profiles 2>/dev/null | grep -v "Available profiles:" | grep -v "^$" | sed 's/^[[:space:]]*//')"})
        _describe 'profiles' profiles
    fi
}

_ak_keys() {
    local keys
    if (( $+commands[ak] )); then
        # Try JSON output first, fall back to plain text
        keys=(${(f)"$(ak secret ls --json 2>/dev/null | grep -o '"name":"[^"]*"' | cut -d'"' -f4 2>/dev/null || ak secret ls 2>/dev/null | awk '{print $1}' | grep -v "Available\|Total\|ðŸ“‚" | grep -v "^$")"})
        _describe 'keys' keys
    fi
}

_ak_profiles_and_keys() {
    local profiles keys combined
    if (( $+commands[ak] )); then
        profiles=(${(f)"$(ak profiles 2>/dev/null | grep -v "Available profiles:" | grep -v "^$" | sed 's/^[[:space:]]*//')"})
        keys=(${(f)"$(ak secret ls --json 2>/dev/null | grep -o '"name":"[^"]*"' | cut -d'"' -f4 2>/dev/null || ak secret ls 2>/dev/null | awk '{print $1}' | grep -v "Available\|Total\|ðŸ“‚" | grep -v "^$")"})
        combined=($profiles $keys)
        _describe 'profiles and keys' combined
    fi
}

_ak_services() {
    local services
    services=(
        'openai:OpenAI API'
        'anthropic:Anthropic Claude API'
        'google:Google APIs'
        'github:GitHub API'
        'gitlab:GitLab API'
        'bitbucket:Bitbucket API'
        'azure:Microsoft Azure APIs'
        'aws:Amazon Web Services APIs'
        'gcp:Google Cloud Platform APIs'
        'digitalocean:DigitalOcean API'
        'linode:Linode API'
        'vultr:Vultr API'
        'hetzner:Hetzner Cloud API'
    )
    _describe 'services' services
}

# Completion for ak-gui
_ak-gui() {
    _arguments \
        '(-h --help)'{-h,--help}'[Show help information]' \
        '(-v --version)'{-v,--version}'[Show version information]' \
        '--profile[Specify profile]:profile:_ak_profiles' \
        '--config[Specify config file]:config file:_files -g "*.conf"' \
        '--theme[UI theme]:theme:(light dark auto)' \
        '--debug[Enable debug mode]'
}

# Register completions
_ak "$@"

# Also handle ak-gui if it exists
if (( $+commands[ak-gui] )); then
    compdef _ak-gui ak-gui
fi
